import pytest
import sys
from pathlib import Path

sys.path.append(str(Path(__file__).parent.parent / "ceruleanserver"))
from process import process_sns # pylint: disable=no-name-in-module


test_json = {
    "Records": [
        {
            "EventSource": "aws:sns",
            "EventVersion": "1.0",
            "EventSubscriptionArn": "arn:aws:sns:eu-central-1:214830741341:SentinelS1L1C:94c822d8-ce87-44b9-bfec-13b2a0a8675b",
            "Sns": {
                "Type": "Notification",
                "MessageId": "09594279-4fa5-56b7-bdce-1568068e0471",
                "TopicArn": "arn:aws:sns:eu-central-1:214830741341:SentinelS1L1C",
                "Subject": "productAdded",
                "Message": "{\n  \"id\" : \"S1A_IW_GRDH_1SDV_20200406T194140_20200406T194205_032011_03B2AB_C112\",\n  \"path\" : \"GRD/2020/4/6/IW/DV/S1A_IW_GRDH_1SDV_20200406T194140_20200406T194205_032011_03B2AB_C112\",\n  \"missionId\" : \"S1B\",\n  \"productType\" : \"GRD\",\n  \"mode\" : \"IW\",\n  \"polarization\" : \"DV\",\n  \"startTime\" : \"2020-04-15T16:07:06\",\n  \"stopTime\" : \"2020-04-15T16:07:31\",\n  \"absoluteOrbitNumber\" : 21157,\n  \"missionDataTakeId\" : 164441,\n  \"productUniqueIdentifier\" : \"9E75\",\n  \"sciHubIngestion\" : \"2020-04-15T16:56:40.034Z\",\n  \"s3Ingestion\" : \"2020-04-15T17:39:36.796Z\",\n  \"sciHubId\" : \"034586fd-33e0-4223-89cf-958ae767734f\",\n  \"footprint\" : {\n    \"type\" : \"MultiPolygon\",\n    \"crs\" : {\n      \"type\" : \"name\",\n      \"properties\" : {\n        \"name\" : \"urn:ogc:def:crs:EPSG:8.8.1:4326\"\n      }\n    },\n    \"coordinates\" : [ [ [ [ 25.81105, 39.659679 ], [ 28.812616, 40.06459 ], [ 28.49769, 41.565166 ], [ 25.427782, 41.161327 ], [ 25.81105, 39.659679 ] ] ] ]\n  },\n  \"filenameMap\" : {\n    \"measurement/s1b-iw-grd-vh-20200406T194140_20200406T194205_032011_03B2AB-002.tiff\" : \"measurement/iw-vh.tiff\",\n    \"support/s1-level-1-calibration.xsd\" : \"support/s1-level-1-calibration.xsd\",\n    \"support/s1-map-overlay.xsd\" : \"support/s1-map-overlay.xsd\",\n    \"annotation/s1b-iw-grd-vh-20200406T194140_20200406T194205_032011_03B2AB-002.xml\" : \"annotation/iw-vh.xml\",\n    \"preview/map-overlay.kml\" : \"preview/map-overlay.kml\",\n    \"annotation/calibration/noise-s1b-iw-grd-vh-20200406T194140_20200406T194205_032011_03B2AB-002.xml\" : \"annotation/calibration/noise-iw-vh.xml\",\n    \"annotation/s1b-iw-grd-vv-20200406T194140_20200406T194205_032011_03B2AB-001.xml\" : \"annotation/iw-vv.xml\",\n    \"support/s1-product-preview.xsd\" : \"support/s1-product-preview.xsd\",\n    \"support/s1-object-types.xsd\" : \"support/s1-object-types.xsd\",\n    \"support/s1-level-1-quicklook.xsd\" : \"support/s1-level-1-quicklook.xsd\",\n    \"preview/product-preview.html\" : \"preview/product-preview.html\",\n    \"measurement/s1b-iw-grd-vv-20200406T194140_20200406T194205_032011_03B2AB-001.tiff\" : \"measurement/iw-vv.tiff\",\n    \"annotation/calibration/calibration-s1b-iw-grd-vh-20200406T194140_20200406T194205_032011_03B2AB-002.xml\" : \"annotation/calibration/calibration-iw-vh.xml\",\n    \"S1A_IW_GRDH_1SDV_20200406T194140_20200406T194205_032011_03B2AB_C112.SAFE-report-20200415T163033.pdf\" : \"report-20200415T163033.pdf\",\n    \"annotation/calibration/calibration-s1b-iw-grd-vv-20200406T194140_20200406T194205_032011_03B2AB-001.xml\" : \"annotation/calibration/calibration-iw-vv.xml\",\n    \"support/s1-level-1-measurement.xsd\" : \"support/s1-level-1-measurement.xsd\",\n    \"support/s1-level-1-noise.xsd\" : \"support/s1-level-1-noise.xsd\",\n    \"support/s1-level-1-product.xsd\" : \"support/s1-level-1-product.xsd\",\n    \"preview/quick-look.png\" : \"preview/quick-look.png\",\n    \"manifest.safe\" : \"manifest.safe\",\n    \"preview/icons/logo.png\" : \"preview/icons/logo.png\",\n    \"annotation/calibration/noise-s1b-iw-grd-vv-20200406T194140_20200406T194205_032011_03B2AB-001.xml\" : \"annotation/calibration/noise-iw-vv.xml\"\n  }\n}",
                "Timestamp": "2020-04-15T17:39:55.875Z",
                "SignatureVersion": "1",
                "Signature": "CvhqoizHTIyeanJE2aK+iG1oWWfAI0nQywyE2oIlVUXo7lkpfandmbqRn5ee6D5NWXvvfqzNwpQ/IRUofIchdWADhxwhae5sJZ6axbIfYc7jqyjQZ45G0jlnflstXo3fKFyYZOg1NDbWo52phwIRm8sQ5cDVYAu0ugSXkjm37KWSP59jyQv9KgeHBY6WhRI9iKzGV4wCJ5TTleF6hPoxtZ1MFQaU7/cmHsQc7kkSvpqCFGaMgNa71T+4w0AhSQe1Dd8aw4Cl8e5IiByyFhB+lt7HU8QFA+mhimaCG2iSLNAKK3CqDfKxj692kQiVCEzbuy8R8wb7YWnnTx4QFcG19w==",
                "SigningCertUrl": "https://sns.eu-central-1.amazonaws.com/SimpleNotificationService-a86cb10b4e1f29c941702d737128f7b6.pem",
                "UnsubscribeUrl": "https://sns.eu-central-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-central-1:214830741341:SentinelS1L1C:94c822d8-ce87-44b9-bfec-13b2a0a8675b",
                "MessageAttributes": {}
            }
        }
    ]
}


# Fails because of OCN duplication
# test_json = {'Type': 'Notification', 'MessageId': '6058685c-d2ce-52b2-882f-3fcc6cbd47b5', 'TopicArn': 'arn:aws:sns:eu-central-1:214830741341:SentinelS1L1C', 'Subject': 'productAdded', 'Message': '{\n  "id" : "S1A_IW_GRDH_1SDV_20200720T165734_20200720T165759_033541_03E2F9_492B",\n  "path" : "GRD/2020/7/20/IW/DV/S1A_IW_GRDH_1SDV_20200720T165734_20200720T165759_033541_03E2F9_492B",\n  "missionId" : "S1A",\n  "productType" : "GRD",\n  "mode" : "IW",\n  "polarization" : "DV",\n  "startTime" : "2020-07-20T16:57:34",\n  "stopTime" : "2020-07-20T16:57:59",\n  "absoluteOrbitNumber" : 33541,\n  "missionDataTakeId" : 254713,\n  "productUniqueIdentifier" : "492B",\n  "sciHubIngestion" : "2020-07-20T18:42:51.110Z",\n  "s3Ingestion" : "2020-07-21T09:57:51.104Z",\n  "sciHubId" : "05e41336-7ae3-446c-81ce-e117bb8f80a8",\n  "footprint" : {\n    "type" : "MultiPolygon",\n    "crs" : {\n      "type" : "name",\n      "properties" : {\n        "name" : "urn:ogc:def:crs:EPSG:8.8.1:4326"\n      }\n    },\n    "coordinates" : [ [ [ [ 13.211827, 40.723129 ], [ 16.259325, 41.126633 ], [ 15.956771, 42.628498 ], [ 12.837567, 42.226345 ], [ 13.211827, 40.723129 ] ] ] ]\n  },\n  "filenameMap" : {\n    "support/s1-level-1-calibration.xsd" : "support/s1-level-1-calibration.xsd",\n    "annotation/calibration/noise-s1a-iw-grd-vv-20200720t165734-20200720t165759-033541-03e2f9-001.xml" : "annotation/calibration/noise-iw-vv.xml",\n    "support/s1-map-overlay.xsd" : "support/s1-map-overlay.xsd",\n    "annotation/calibration/calibration-s1a-iw-grd-vh-20200720t165734-20200720t165759-033541-03e2f9-002.xml" : "annotation/calibration/calibration-iw-vh.xml",\n    "preview/map-overlay.kml" : "preview/map-overlay.kml",\n    "annotation/s1a-iw-grd-vv-20200720t165734-20200720t165759-033541-03e2f9-001.xml" : "annotation/iw-vv.xml",\n"measurement/s1a-iw-grd-vv-20200720t165734-20200720t165759-033541-03e2f9-001.tiff" : "measurement/iw-vv.tiff",\n    "S1A_IW_GRDH_1SDV_20200720T165734_20200720T165759_033541_03E2F9_492B.SAFE-report-20200720T180712.pdf" : "report-20200720T180712.pdf",\n    "annotation/s1a-iw-grd-vh-20200720t165734-20200720t165759-033541-03e2f9-002.xml" : "annotation/iw-vh.xml",\n    "support/s1-product-preview.xsd" : "support/s1-product-preview.xsd",\n    "support/s1-object-types.xsd" : "support/s1-object-types.xsd",\n    "support/s1-level-1-quicklook.xsd" : "support/s1-level-1-quicklook.xsd",\n    "preview/product-preview.html" : "preview/product-preview.html",\n    "support/s1-level-1-measurement.xsd" : "support/s1-level-1-measurement.xsd",\n   "support/s1-level-1-noise.xsd" : "support/s1-level-1-noise.xsd",\n    "support/s1-level-1-product.xsd" : "support/s1-level-1-product.xsd",\n    "preview/quick-look.png" : "preview/quick-look.png",\n    "manifest.safe" : "manifest.safe",\n    "preview/icons/logo.png" : "preview/icons/logo.png",\n    "annotation/calibration/noise-s1a-iw-grd-vh-20200720t165734-20200720t165759-033541-03e2f9-002.xml" : "annotation/calibration/noise-iw-vh.xml",\n    "measurement/s1a-iw-grd-vh-20200720t165734-20200720t165759-033541-03e2f9-002.tiff" : "measurement/iw-vh.tiff",\n    "annotation/calibration/calibration-s1a-iw-grd-vv-20200720t165734-20200720t165759-033541-03e2f9-001.xml" : "annotation/calibration/calibration-iw-vv.xml"\n  }\n}', 'Timestamp': '2020-07-21T09:58:11.388Z', 'SignatureVersion': '1', 'Signature': 'h4V/6xcUMO9W5FmF7X68HafSWcf9bKqW4uLOTFYn2/We0bbqWk0yKmLsfjL/h1QJXIw9q0YZSsNxwT96FL79G1St29QetIlPipjJj+clQwPAn1Tw8jjqFPyEdnUmJEXZPDqPk6sxMCAqDi50Ay1gLZ6O5SULm28fGcGQRjuLq5KC+J/EI/PxPsflpqjVNwdsoQBuY+qE2s2c+uGOORQiN2sa0zl2B9v/fUFnSQa6w36y9Sygi5FGKAWwNMtSUNijrxExLKgAVpAFq5SWzhOfQ/XwH2xMyj/15g2xv/ghLGREwZ0S6/sDOFNLbRzQYn8MnF95ZlgQA2oC9JDZ5QlV+w==', 'SigningCertUrl': 'https://sns.eu-central-1.amazonaws.com/SimpleNotificationService-a86cb10b4e1f29c941702d737128f7b6.pem', 'UnsubscribeUrl': 'https://sns.eu-central-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-central-1:214830741341:SentinelS1L1C:a47700f2-68b0-4761-9a9b-ee9cd674c68e', 'MessageAttributes': {}}


process_sns(test_json['Records'][0]["Sns"])
